name: Build AmneziaWG for NanoPi R3S (auto-detect ImageBuilder)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect and download ImageBuilder
        run: |
          BASE_URL="https://downloads.immortalwrt.org/releases/24.10.4/targets/rockchip/armv8/"
          echo "Fetching directory listing..."
          curl -s $BASE_URL > listing.txt

          FILE=$(grep -o 'immortalwrt-imagebuilder-rockchip-armv8[^"]*' listing.txt | head -n 1)

          if [ -z "$FILE" ]; then
            echo "ERROR: ImageBuilder not found on server"
            exit 1
          fi

          echo "Found ImageBuilder: $FILE"
          wget "${BASE_URL}${FILE}"

          if [[ "$FILE" == *.zst ]]; then
            echo "Extracting .tar.zst..."
            tar -I unzstd -xf "$FILE"
          else
            echo "Extracting .tar.xz..."
            tar -xf "$FILE"
          fi

          mv immortalwrt-imagebuilder-rockchip-armv8* builder

      - name: Fix kernel version (hard lock to 6.6.110)
        run: |
          sed -i 's/^\(LINUX_VERSION-6.6 =\).*/\1 6.6.110/' builder/include/kernel-version.mk
          sed -i 's/^\(LINUX_KERNEL_HASH-6.6.110 =\).*/\1 skip/' builder/include/kernel-version.mk

      - name: Add AmneziaWG package
        run: |
          cp -r package/amneziawg builder/package/

      - name: Configure build
        run: |
          cd builder
          echo "CONFIG_TARGET_rockchip=y" >> .config
          echo "CONFIG_TARGET_rockchip_armv8=y" >> .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r3s=y" >> .config
          echo "CONFIG_PACKAGE_kmod-amneziawg=y" >> .config
          echo "CONFIG_PACKAGE_amneziawg=y" >> .config
          echo "CONFIG_PACKAGE_amneziawg-tools=y" >> .config
          echo "CONFIG_PACKAGE_luci-proto-amneziawg=y" >> .config
          make defconfig

      - name: Build AmneziaWG packages
        run: |
          cd builder
          make package/kmod-amneziawg/compile V=s
          make package/amneziawg/compile V=s
          make package/amneziawg-tools/compile V=s || true
          make package/luci-proto-amneziawg/compile V=s || true

      - name: Prepare release files
        run: |
          mkdir release
          find builder/bin/packages -name "*.ipk" -exec cp {} release/ \;

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: amneziawg-r3s-${{ github.run_number }}
          name: "AmneziaWG for NanoPi R3S (build ${{ github.run_number }})"
          draft: false
          prerelease: false
          files: release/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
