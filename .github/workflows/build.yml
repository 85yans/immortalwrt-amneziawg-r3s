name: Build kmod-amneziawg via kernel-debug.tar.zst

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download kernel headers
        run: |
          BASE_URL="https://downloads.immortalwrt.org/releases/24.10.4/targets/rockchip/armv8/"
          FILE="kernel-debug.tar.zst"
          wget "${BASE_URL}${FILE}"
          mkdir kernel
          tar -I unzstd -xf "$FILE" -C kernel

      - name: Build kmod-amneziawg
        run: |
          make -C kernel M=$(pwd)/package/amneziawg/src \
            ARCH=arm64 \
            CROSS_COMPILE=aarch64-openwrt-linux- \
            modules

      - name: Package .ko into .ipk
        run: |
          mkdir -p ipk/CONTROL
          cp package/amneziawg/src/amneziawg.ko ipk/
          echo "Package: kmod-amneziawg" > ipk/CONTROL/control
          echo "Version: 6.6.110-1" >> ipk/CONTROL/control
          echo "Architecture: aarch64_generic" >> ipk/CONTROL/control
          echo "Description: AmneziaWG kernel module" >> ipk/CONTROL/control
          echo "Maintainer: AmneziaVPN" >> ipk/CONTROL/control
          echo "Section: kernel" >> ipk/CONTROL/control
          echo "Priority: optional" >> ipk/CONTROL/control
          echo "Installed-Size: 64" >> ipk/CONTROL/control
          echo "Source: amneziawg-openwrt" >> ipk/CONTROL/control
          echo "Depends: kernel (=6.6.110)" >> ipk/CONTROL/control
          echo "License: MIT" >> ipk/CONTROL/control
          echo "Homepage: https://github.com/amnezia-vpn/amneziawg-openwrt" >> ipk/CONTROL/control
          tar -czf control.tar.gz -C ipk/CONTROL .
          tar -czf data.tar.gz -C ipk amneziawg.ko
          echo "2.0" > debian-binary
          mkdir release
          ar r release/kmod-amneziawg_6.6.110-1_aarch64_generic.ipk debian-binary control.tar.gz data
